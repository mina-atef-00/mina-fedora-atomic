name: Build installer ISOs

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Build container image"]
    types: [completed]

env:
  IMAGE_REGISTRY: "ghcr.io/${{ github.repository_owner }}"
  DEFAULT_TAG: "latest"
  BIB_IMAGE: "quay.io/centos-bootc/bootc-image-builder:latest"

concurrency:
  group: build-iso-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  iso:
    name: Build ISO (${{ matrix.image_name }})
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-24.04

    strategy:
      fail-fast: false
      matrix:
        include:
          - profile: asus
            image_name: mina-fedora-atomic-desktop
          - profile: lnvo
            image_name: mina-fedora-atomic-laptop

    permissions:
      contents: read
      packages: read

    steps:
      - name: Maximize build space
        uses: ublue-os/remove-unwanted-software@cc0becac701cf642c8f0a6613bbdaf5dc36b259e # v9
        with:
          remove-codeql: true

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Prepare variables
        run: |
          echo "IMAGE_REGISTRY=${IMAGE_REGISTRY,,}" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV
          echo "SHORT_SHA=${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}" >> $GITHUB_ENV
          echo "USER_UID=$(id -u)" >> $GITHUB_ENV
          echo "USER_GID=$(id -g)" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate ISO config
        run: |
          set -euo pipefail
          IMAGE_URI="${IMAGE_REGISTRY}/${{ matrix.image_name }}:${DEFAULT_TAG}"
          SWITCH_CMD="bootc switch --mutate-in-place --transport registry ${IMAGE_URI}"
          
          sed "s|@@BOOTC_SWITCH_COMMAND@@|${SWITCH_CMD}|g" \
            disk_config/iso-base.toml > disk_config/_generated.toml
          
          echo "Generated config:"
          cat disk_config/_generated.toml

      - name: Build ISO
        id: build
        uses: osbuild/bootc-image-builder-action@main
        with:
          builder-image: ${{ env.BIB_IMAGE }}
          config-file: './disk_config/_generated.toml'
          image: ${{ env.IMAGE_REGISTRY }}/${{ matrix.image_name }}:${{ env.DEFAULT_TAG }}
          chown: ${{ env.USER_UID }}:${{ env.USER_GID }}
          types: anaconda-iso
          additional-args: --use-librepo=True --rootfs btrfs

      - name: Package ISO with checksum
        run: |
          set -euo pipefail
          mkdir -p output
          
          ISO_NAME="${{ matrix.image_name }}-${BUILD_DATE}.iso"
          ISO_SRC=$(find ${{ steps.build.outputs.output-directory }} -name '*.iso' | head -1)
          
          mv "${ISO_SRC}" "output/${ISO_NAME}"
          cd output
          sha256sum "${ISO_NAME}" > "${ISO_NAME}.sha256"
          
          echo "=== Built ISO ==="
          ls -lh

      - name: Upload ISO
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: ${{ matrix.image_name }}-iso
          path: output/
          if-no-files-found: error
          retention-days: 7
          compression-level: 0
